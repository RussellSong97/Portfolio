<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<th:block layout:fragment="content">
    <div class="w-set">
        <div class="divide-flex">
            <div class="divide-left">
                <div class="find-wrap">
                    <div class="find-top">
                        <div class="count-area">
                            <span class="count-tit">내 차 구입</span>
                            <p class="count"><span class="num" th:text="${productList.size()}">12,150</span>대</p>
                        </div>
                        <div class="btn-wrap">
                            <button type="button" class="btn-reset" id="btn-reset">초기화</button>
                        </div>
                    </div>
                    <div class="find-group">
                        <fieldset>
                            <legend>FInd Car</legend>
                            <div class="schlist model">
                                <p class="schlist-tit">제조사/모델 /상세 모델</p>
                                <div class="filter-wrap">
                                    <div class="deparea maker" id="first-category">
                                        <dl class="deplist">
                                            <dt class="is-blind">제조사</dt>
                                            <dd>
                                                <span class="filter on" th:each="first : ${firstCategoryList}">
                                                        <a href="javascript:" class="first-category category"
                                                           th:attr="data-id=${first.id}, data-depth=${first.depth}">
                                                            <i class="i-maker"
                                                               th:if="${first.carImage != null}"
                                                               th:style="'background-image: url(/api/file/view/' + ${first.carImage.uuid} + '?size=1500);'">
                                                               <!-- 배경 이미지가 없는 경우, 기본 배경 이미지 설정 -->
                                                               <th:block th:unless="${first.carImage != null}"
                                                                         th:style="'background-image: url(/path/to/default/image.png);'">
                                                               </th:block>
                                                            </i>
                                                            <th:block th:text="${first.linkDataNm}"></th:block>
                                                        </a>
                                                        <span class="num">389</span>
                                                    <button type="button" class="btn-del">삭제</button>
                                                </span>
                                                <div class="deparea model">
                                                    <dl class="deplist category-list">
                                                        <dt class="is-blind">모델</dt>
                                                        <dd id="second-category-container">
                                                            <!--                                                                                                                        <span class="filter">-->
                                                            <!--                                                                                                                          <a href="javascript:;" class="on">Avante</a>-->
                                                            <!--                                                                                                                          <span class="num">389</span>-->
                                                            <!--                                                                                                                          <button type="button" class="btn-del">삭제</button>-->
                                                            <!--                                                                                                                        </span>-->
                                                            <div class="deparea demodel third-category">
                                                                <!--                                                                <dl class="deplist">-->
                                                                <!--                                                                    <dt class="is-blind">세부모델</dt>-->
                                                                <!--                                                                    <dd>-->
                                                                <!--                                                                      <span class="filter on">-->
                                                                <!--                                                                        <a href="javascript:"-->
                                                                <!--                                                                           class="on">The New Avante</a>-->
                                                                <!--                                                                        <span class="num">20</span>-->
                                                                <!--                                                                        <button type="button"-->
                                                                <!--                                                                                class="btn-del">삭제</button>-->
                                                                <!--                                                                      </span>-->
                                                                <!--                                                                    </dd>-->
                                                                <!--                                                                </dl>-->
                                                            </div>
                                                        </dd>
                                                        <dd>
                                                            <!--                                                        <span class="filter">-->
                                                            <!--                                                          <a href="javascript:">캐스퍼</a>-->
                                                            <!--                                                          <span class="num">133</span>-->
                                                            <!--                                                          <button type="button" class="btn-del">삭제</button>-->
                                                            <!--                                                        </span>-->
                                                        </dd>
                                                    </dl>
                                                </div>
                                            </dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                            <div class="schlist price">
                                <a href="javascript:" class="schlist-tit">
                                    가격
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont">
                                    <div class="slider" id="slider1">
                                        <!-- 값 표시 -->
                                        <div class="value-area">
                                            <span class="all">전체</span>
                                            <!-- 선택값 -->
                                            <div class="value-label left">1000만원</div>
                                            <span class="to">~</span>
                                            <div class="value-label right">10000만원</div>
                                        </div>
                                        <input type="range" id="slider1-left" min="1" max="9000000" value="1"/>
                                        <input type="range" id="slider1-right" min="1" max="9000000" value="9000000"/>
                                        <div class="track">
                                            <div class="range"></div>
                                            <div class="thumb left"></div>
                                            <div class="thumb right"></div>
                                        </div>
                                    </div>
                                    <!-- 직접입력 체크 박스 클릭시 -->
                                    <div class="input-wrap price" id="writePriceTag" style="display: none;">
                                        <div class="input-box">
                                            <label for="leftPrice">만원</label>
                                            <input type="text" name="amount" id="leftPrice" placeholder="">
                                        </div>
                                        <span>~</span>
                                        <div class="input-box">
                                            <label for="rightPrice">만원</label>
                                            <input type="text" name="amount" id="rightPrice" placeholder="">
                                        </div>
                                    </div>
                                    <!-- // 직접입력 체크 박스 클릭시 -->
                                    <div class="input-wrap type-switch">
                                        <div class="checkbox">
                                            <input type="checkbox" name="direct" id="directPrice">
                                            <label for="directPrice" class="txt">직접입력</label>
                                        </div>
                                    </div>
                                    <div class="btn-wrap">
                                        <button type="button" class="btn" id="searchDistanceBtn">검색</button>
                                    </div>
                                </div>
                            </div>
                            <div class="schlist price">
                                <a href="javascript:" class="schlist-tit">
                                    주행거리
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont">
                                    <div class="slider" id="slider2">
                                        <div class="value-area">
                                            <span class="all">전체</span>
                                            <div class="value-label left" id="left-value">1km</div>
                                            <span class="to">~</span>
                                            <div class="value-label right" id="right-value">9000km</div>
                                        </div>
                                        <input type="range" id="slider2-left" min="1" max="9000" value="1"/>
                                        <input type="range" id="slider2-right" min="1" max="9000" value="9000"/>
                                        <div class="track">
                                            <div class="range"></div>
                                            <div class="thumb left"></div>
                                            <div class="thumb right"></div>
                                        </div>
                                    </div>
                                    <div class="input-wrap price" id="writeKm" style="display: none;">
                                        <div class="input-box">
                                            <label for="leftKm">Km</label>
                                            <input type="text" name="amount" id="leftKm" placeholder="">
                                        </div>
                                        <span>~</span>
                                        <div class="input-box">
                                            <label for="rightKm">Km</label>
                                            <input type="text" name="amount" id="rightKm" placeholder="">
                                        </div>
                                    </div>
                                    <div class="input-wrap type-switch">
                                        <div class="checkbox">
                                            <input type="checkbox" name="direct" id="directKm">
                                            <label for="directKm" class="txt">직접입력</label>
                                        </div>
                                    </div>
                                    <div class="btn-wrap">
                                        <button type="button" class="btn" id="searchUseKmBtn">검색</button>
                                    </div>
                                </div>
                            </div>
                            <div class="schlist year">
                                <a href="javascript:" class="schlist-tit">
                                    연식
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont">
                                    <div class="input-wrap range">
                                        <div class="input-box">
                                            <label for="startYear">부터</label>
                                            <select name="startYear" id="startYear" required>
                                                <option th:value="${year}" th:each="year : ${yearList}"
                                                        th:text="${year + '년'}">2023
                                                </option>
                                            </select>
                                        </div>
                                        <span>~</span>
                                        <div class="input-box">
                                            <label for="endYear">까지</label>
                                            <select name="endYear" id="endYear" required>
                                                <option th:value="${year}" th:each="year : ${yearList}"
                                                        th:text="${year + '년'}">2023
                                                </option>
                                            </select>
                                        </div>
                                    </div>
                                    <ul id="productList"></ul>
                                </div>
                            </div>
                            <div class="schlist fuel">
                                <a href="javascript:" class="schlist-tit" onclick="toggleVisibility()">
                                    연료
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont">
                                    <ul class="checkbox_list" id="fuelTag">

                                    </ul>
                                </div>
                            </div>
                            <div class="schlist transmission">
                                <a href="javascript:" class="schlist-tit" onclick="searchIstdTrans()">
                                    변속기
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont hidden" id="transmissionContent">
                                    <ul class="checkbox_list" id="istdTransTag">
                                    </ul>
                                </div>
                            </div>
                            <div class="schlist color">
                                <a href="javascript:" class="schlist-tit" onclick="searchColor()">
                                    색상
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont">
                                    <ul class="checkbox_list" id="colorTag">
                                    </ul>
                                </div>
                            </div>
                            <div class="schlist location">
                                <a href="javascript:" class="schlist-tit" onclick="searchSido()">
                                    지역
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont">
                                    <ul class="checkbox_list" id="sidoTag">

                                    </ul>
                                </div>
                            </div>
                            <div class="schlist option">
                                <a href="javascript:" class="schlist-tit" onclick="searchOption()">
                                    옵션
                                    <i class="ico-toggle"></i>
                                </a>
                                <div class="schlist-cont">
                                    <ul class="checkbox_list" id="optionTag">
                                    </ul>
                                    <button type="button" class="btn-popup" onclick="searchMoreOption()">+ <span>다른 옵션 더 보기</span>
                                    </button>
                                    <div class="popup">
                                        <div class="popup-header">
                                            <span class="tit">옵션</span>
                                            <a href="#" class="link">옵션설명보기</a>
                                            <button class="popup-close">닫기</button>
                                        </div>
                                        <div class="option_wrap" id="optionListTag">

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="schlist search">
                                <p class="schlist-tit">차량번호 검색</p>
                                <div class="search_form">
                                    <input type="text" name="searchCarPlateNumber" id="searchCarPlateNumber"
                                           placeholder="">
                                    <button type="button" class="btn_search" onclick="searchCarPlatNumber()">Search
                                    </button>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
            <div class="divide-right">
                <div class="find-result">
                    <a href="/search/mobile" class="search-box hide-pc">모델, 차량번호 검색</a>
                    <div class="result-top">
                        <div class="result-text" id="selectedFiltersContainer">
                            <!--                            <div class="txt">현대 더 뉴 아반떼-->
                            <!--                                <button type="button" class="btn-del">삭제</button>-->
                            <!--                            </div>-->
                            <!--                            <div class="txt">제네시스-->
                            <!--                                <button type="button" class="btn-del">삭제</button>-->
                            <!--                            </div>-->
                            <!--                            <div class="txt">제네시스-->
                            <!--                                <button type="button" class="btn-del">삭제</button>-->
                            <!--                            </div>-->
                            <!--                            <div class="txt">제네시스-->
                            <!--                                <button type="button" class="btn-del">삭제</button>-->
                            <!--                            </div>-->
                            <!--                            <div class="txt">제네시스-->
                            <!--                                <button type="button" class="btn-del">삭제</button>-->
                            <!--                            </div>-->
                        </div>
                        <button type="button" class="btn-reset hide-m" id="btn-reset-filters">초기화</button>
                        <a href="/search/product/mobile/filter" class="btn-filter hide-pc">필터</a>
                    </div>
                    <div class="result-cont">
                        <ul class="sort-list">
                            <li>
                                <input type="radio" name="sortBy" value="pick" id="sort1">
                                <label for="sort1" class="sort">인기순</label>
                            </li>
                            <li>
                                <input type="radio" name="sortBy" value="recent" id="sort2">
                                <label for="sort2" class="sort">최신순</label>
                            </li>
                            <li>
                                <input type="radio" name="sortBy" value="downPrice" id="sort3">
                                <label for="sort3" class="sort">저가순</label>
                            </li>
                            <li>
                                <input type="radio" name="sortBy" value="upPrice" id="sort4">
                                <label for="sort4" class="sort">고가순</label>
                            </li>
                        </ul>
                        <p class="total hide-pc"><strong>1,500</strong>개의 상품</p>
                        <ul class="result-list" id="product-list">
                            <li th:each="car : ${productList}">
                                <!-- 선착순 특가 badge -->
                                <div class="prd-box"
                                     th:classappend="${car.shopName.contains('(주)디에스오토')} ? ' badge' : ''">
                                    <div class="prd-thumb">
                                        <label class="btn-like">
                                            <input type="checkbox"
                                                   th:attr="productId=${car.productId}"
                                                   th:checked="${car.picked}"
                                                   class="pick_check">
                                            <span class="like-visual">좋아요</span>
                                        </label>
                                        <a th:href="'/product/' + ${car.productId}">
                                            <img th:src="${car.carImageUrl[0].realUrl}" alt="이미지">
                                        </a>
                                    </div>
                                    <a href="../vehicle/vehicle_view.html" class="prd-info">
                                        <p class="prd-name"
                                           th:text="${car.makerName + ' ' + car.modelName + ' ' + car.detailGradeName}">
                                            KIA 더 뉴 쏘렌토 4세대(MQ4) 디젤 2.2 2WD 노블레스(5인승)아 더 뉴
                                            쏘렌토 4세대(MQ4) 디젤 2.2 2WD 노블레스(5인승)</p>
                                        <p class="price-info">
                                            <span class="num-price" th:text="${car.getFormattedCarAmountSale()}">13,700만원</span>
                                        </p>
                                        <p class="detail-info">
                                            <span th:text="${car.carRegYear}">2019/04(2019)</span>
                                            <span th:text="${#numbers.formatInteger(car.carUseKm, 1, 'COMMA') + ' km'}">11,179 km</span>
                                            <span th:text="${car.city}">서울</span>
                                        </p>
                                    </a>
                                </div>
                            </li>
                        </ul>
                        <!-- 로딩바 -->
                        <!--          <div class="load-wrap">-->
                        <!--            <div class="spinner-svg"></div>-->
                        <!--          </div>-->
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<script layout:fragment="script" th:inline="javascript">
    //서브 페이지 제목
    var hdNm = "내 차 구입";

    // 공통 fetch 함수
    function fetchData(url, method, requestBody, onSuccess, onError) {
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
            .then(response => {
                if (!response.ok) {
                    // 응답 상태 코드가 2xx가 아니면 에러를 던집니다.
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.code === 200) {
                    onSuccess(data);
                } else {
                    // 서버 응답의 code가 200이 아닌 경우 처리합니다.
                    if (onError) {
                        onError(data);
                    } else {
                        alert('데이터를 불러오는 데 실패했습니다.');
                    }
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('서버 오류가 발생했습니다.');
            });
    }

    function renderProductList(data) {
        console.log(data)
        const productListElement = document.querySelector('#product-list');
        productListElement.innerHTML = '';

        data.forEach(product => {
            const listItem = createProductListItem(product);
            productListElement.appendChild(listItem);
        });
    }

    // 검색 결과 리스트 그리는 부분 (공통)
    function createProductListItem(product) {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
            <div class="prd-box badge">
                <div class="prd-thumb">
                    <label class="btn-like">
                        <input type="checkbox"
                        th:attr="productId=${product.productId}"
                        th:checked="${product.picked}"
                        class="pick_check">
                        <span class="like-visual">좋아요</span>
                    </label>
                    <a href="/product/${product.productId}">
                        <img src="${product.carImageUrl[0].realUrl}" alt="이미지">
                    </a>
                </div>
                <a href="/product/${product.productId}" class="prd-info">
                    <p class="prd-name">${product.makerName} ${product.modelName} ${product.detailGradeName}</p>
                    <p class="price-info">
                        <span class="num-price">${product.formattedCarAmountSale}</span>
                    </p>
                    <p class="detail-info">
                        <span>${product.carRegYear}</span>
                        <span>${new Intl.NumberFormat().format(product.carUseKm)} km</span>
                        <span>${product.city}</span>
                    </p>
                </a>
            </div>
        `;
        return listItem;
    }


    // 공통 함수 정의
    function fetchDataAndRender(url, elementId, itemKeyMappings) {
        fetchData(url, 'POST', {}, (result) => {
            console.log(result)
            let targetElement = document.getElementById(elementId);
            targetElement.innerHTML = '';

            result.data.forEach((item, index) => {
                let html = `
                <li>
                    <div class="input-wrap">
                        <div class="checkbox">
                            <input type="checkbox" ${itemKeyMappings.inputAttributes(item, index)}>
                            <label for="${itemKeyMappings.labelForPrefix}_${index + 1}">${itemKeyMappings.labelText(item)}</label>
                        </div>
                    </div>
                    <span class="num">${itemKeyMappings.count(item)}</span>
                </li>`;
                targetElement.innerHTML += html;
            });

            if (itemKeyMappings.afterRender) {
                itemKeyMappings.afterRender();
            }
        }, () => {
            if (itemKeyMappings.errorMessage) {
                alert(itemKeyMappings.errorMessage);
            }
        });
    }

    // 이벤트 리스너 등록 함수
    function addCheckboxListeners(name, callback) {
        document.querySelectorAll(`input[name="${name}"]`).forEach(checkbox => {
            checkbox.addEventListener('click', callback);
        });
    }


    // 1차 카테고리 클릭시 2차 카테고리 불러오는 함수
    let selectedCategoryIds = {
        category1:'',
        category2:'',
        category3:''
    };

    // 1차 카테고리 클릭
    document.querySelectorAll('.first-category').forEach(tag => {
        tag.addEventListener('click', function () {
            const isOn = tag.classList.contains("on");
            const firstCategoryId = tag.getAttribute('data-id');
            const depth = parseInt(tag.getAttribute('data-depth')) + 1;

            if (isOn) {
                tag.classList.remove("on");
                selectedCategoryIds.category1 = null; // 1차 카테고리 선택 해제
                fetchData('/api/search/product', 'POST',
                    { categoryId: null, depth: depth },
                    (data) => {
                        console.log(data);
                        renderProductList(data.data); // 상품 리스트 렌더링
                        drawCategory(data.info, firstCategoryId, tag); // 카테고리 그리기
                    },
                    (error) => {
                        console.log(error);
                        alert('2차 카테고리를 불러오는 데 실패했습니다.');
                    }
                );
            } else {
                tag.classList.add("on");
                selectedCategoryIds.category1 = firstCategoryId; // 1차 카테고리 선택
                fetchData('/api/search/product', 'POST',
                    { categoryId: firstCategoryId, depth: depth },
                    (data) => {
                        console.log(data);
                        renderProductList(data.data); // 상품 리스트 렌더링
                        drawCategory(data.info, firstCategoryId, tag); // 카테고리 그리기
                    },
                    () => {
                        alert('2차 카테고리를 불러오는 데 실패했습니다.');
                    }
                );
            }
        });
    });

    // 2차 카테고리 클릭
    function secondCategory(_this) {
        const isOn = _this.classList.contains("on");
        _this.classList.toggle("on", !isOn);
        const id = _this.getAttribute("data-id");
        const depth = parseInt(_this.getAttribute('data-depth')) + 1;

        if (isOn) {
            _this.classList.remove("on");
            selectedCategoryIds.category2 = null; // 2차 카테고리 선택 해제
            fetchData('/api/search/product', 'POST', { categoryId: null, depth: depth },
                (result) => {
                    console.log(result);
                    renderProductList(result.data);
                    drawThirdCategory(result.info, id, _this); // 하위 카테고리 그리기
                },
                (error) => {
                    console.log(error);
                }
            );
        } else {
            _this.classList.add("on");
            selectedCategoryIds[2] = id; // 2차 카테고리 선택
            fetchData('/api/search/product', 'POST', { categoryId: id, depth: depth },
                (result) => {
                    console.log(result);
                    renderProductList(result.data);
                    drawThirdCategory(result.info, id, _this); // 하위 카테고리 그리기
                },
                () => {
                    alert('하위 카테고리를 불러오는 데 실패했습니다.');
                }
            );
        }
    }

    // 3차 카테고리 클릭
    function searchThirdCategory(id, depth, _this) {
        const isOn = _this.classList.contains("on");

        if (isOn) {
            _this.classList.remove("on");
            selectedCategoryIds[3] = null; // 3차 카테고리 선택 해제
            fetchData('/api/search/product', 'POST', { categoryId: null, depth: depth + 1 }, (result) => {
                renderProductList(result.data);
            });
        } else {
            _this.classList.add("on");
            selectedCategoryIds[3] = id; // 3차 카테고리 선택
            console.log(selectedCategoryIds)
            return false;
            fetchData('/api/search/product', 'POST', { categoryId: id, depth: depth + 1 }, (result) => {
                console.log(result);
                renderProductList(result.data);
            });
        }
    }

    // 2차 카테고리 그려주는 함수
    function drawCategory(data, categoryId, clickedTag) {
        console.log(data);

        let parentSpan = clickedTag.closest('.filter');
        let existingContainer = parentSpan.nextElementSibling;

        if (existingContainer && existingContainer.classList.contains('deparea') && existingContainer.classList.contains('model')) {
            existingContainer.style.display = existingContainer.style.display === 'none' ? 'block' : 'none';
            return;
        }

        if (existingContainer) {
            existingContainer.remove();
        }

        let container = document.createElement('div');
        container.className = 'deparea model';
        container.style.display = 'block';

        let dl = document.createElement('dl');
        dl.className = 'deplist category-list';

        let dt = document.createElement('dt');
        dt.className = 'is-blind';
        dt.textContent = '모델';

        let dd = document.createElement('dd');
        dd.id = `second-category-container-${categoryId}`;

        dl.appendChild(dt);
        dl.appendChild(dd);
        container.appendChild(dl);

        let nextSibling = parentSpan.nextElementSibling;
        parentSpan.parentNode.insertBefore(container, nextSibling);

        let secondCategoryContainer = document.getElementById(`second-category-container-${categoryId}`);
        secondCategoryContainer.innerHTML = '';

        data.forEach(item => {
            if (!item || typeof item !== 'object') {
                console.error('Invalid item format:', item);
                return;
            }
            let html = `
        <span class="filter">
            <a href="javascript:;" class="second-category category" onclick="secondCategory(this)" data-depth="${item.depth}" data-id="${item.id}">${item.linkDataNm}</a>
            <span class="num">${item.count}</span>
            <button type="button" class="btn-del">삭제</button>
        </span>`;
            secondCategoryContainer.innerHTML += html;
        });
    }

    // 3차 카테고리 그려주는 함수
    function drawThirdCategory(data, secondCategoryId, clickedElement) {
        let parentSpan = clickedElement.closest('.filter');
        let existingContainer = parentSpan.nextElementSibling;

        if (existingContainer && existingContainer.classList.contains('deparea') && existingContainer.classList.contains('third-category')) {
            if (existingContainer.style.display === 'none') {
                existingContainer.style.display = 'block';
            } else {
                existingContainer.style.display = 'none';
            }
            return;
        }

        if (existingContainer) {
            existingContainer.remove();
        }

        let container = document.createElement('div');
        container.className = 'deparea demodel third-category';
        container.style.display = 'block';

        let dl = document.createElement('dl');
        dl.className = 'deplist';

        let dt = document.createElement('dt');
        dt.className = 'is-blind';
        dt.textContent = '세부모델';

        let dd = document.createElement('dd');

        dl.appendChild(dt);
        dl.appendChild(dd);
        container.appendChild(dl);

        parentSpan.parentNode.insertBefore(container, parentSpan.nextSibling);

        let thirdCategoryContainer = dd;
        thirdCategoryContainer.innerHTML = '';

        data.forEach(item => {
            let html = `
            <span class="filter">
                <a href="javascript:;" class="category" onclick="searchThirdCategory(${item.id}, ${item.depth}, this)">${item.linkDataNm}</a>
                <span class="num">${item.count}</span>
                <button type="button" class="btn-del">삭제</button>
            </span>`;
            thirdCategoryContainer.innerHTML += html;
        });

        let clickedLink = parentSpan.querySelector('a');

        if (clickedLink) {
            clickedLink.classList.toggle('on');
        }
    }

    // 연식 검색 이벤트
    document.getElementById('startYear').addEventListener('change', searchProducts);
    document.getElementById('endYear').addEventListener('change', searchProducts);

    function searchProducts() {
        const startYear = document.getElementById('startYear').value;
        const endYear = document.getElementById('endYear').value;

        // 선택된 카테고리 아이디 조합
        const categoryIds = [selectedCategoryIds[1], selectedCategoryIds[2], selectedCategoryIds[3]].filter(id => id !== null).join(',');

        fetchData('/api/search/product', 'POST', { startYear: startYear, endYear: endYear, categoryIds: categoryIds }, (result) => {
            console.log(result);
            renderProductList(result.data);
        });
    }

    // 체크박스 변경 이벤트
    function handleCheckboxChange() {
        let selectedTransmissions = Array.from(document.querySelectorAll('input[name="transmission"]:checked')).map(checkbox => checkbox.value);
        let selectedOptions = Array.from(document.querySelectorAll('input[name="option"]:checked')).map(checkbox => checkbox.value);
        let selectSidos = Array.from(document.querySelectorAll('input[name="sido"]:checked')).map(checkbox => checkbox.value);
        let selectedFuels = Array.from(document.querySelectorAll('input[name="fuel"]:checked')).map(checkbox => checkbox.value);
        let selectedColors = Array.from(document.querySelectorAll('input[name="color"]:checked')).map(checkbox => checkbox.value);

        fetchData('/api/search/product', 'POST', {
            transmissions: selectedTransmissions,
            selectedOptions: selectedOptions,
            selectSidos: selectSidos,
            selectedFuels: selectedFuels,
            selectedColors: selectedColors
        }, (result) => {
            console.log(result);
            renderProductList(result.data);
        });
    }

    // 연료 태그
    function searchFuelList() {
        // function searchIstdTrans() {
        fetchDataAndRender(
            "/api/search/product/fuel",
            "fuelTag",
            {
                inputAttributes: (item, index) => `data-id="${item.id}" value=${item.carFuel} name="fuel" id="fuel_${index + 1}"`,
                labelForPrefix: 'fuel',
                labelText: item => item.carFuel,
                count: item => item.productCount,
                afterRender: () => addCheckboxListeners('fuel', handleCheckboxChange)
            }
        );
    }

    // 지역 / 시도 태그
    function searchSido() {
        fetchDataAndRender(
            "/api/search/product/sido",
            "sidoTag",
            {
                inputAttributes: (item, index) => `data-id="${item.id}" value=${item.city} name="sido" id="sido_${index + 1}"`,
                labelForPrefix: 'sido',
                labelText: item => item.sido,
                count: item => item.count,
                afterRender: () => addCheckboxListeners('sido', handleCheckboxChange)
            }
        );
    }

    // 변속기 태그
    function searchIstdTrans() {
        fetchDataAndRender(
            "/api/search/product/istd_trans",
            "istdTransTag",
            {
                inputAttributes: (item, index) => `value="${item.carMission}" id="transmission_${index + 1}" name="transmission"`,
                labelForPrefix: 'transmission',
                labelText: item => item.carMission,
                count: item => item.count,
                afterRender: () => addCheckboxListeners('transmission', handleCheckboxChange)
            }
        );
    }

    // 색상 태그
    function searchColor() {
        fetchDataAndRender(
            "/api/search/product/color",
            "colorTag",
            {
                inputAttributes: (item, index) => `value="${item.colorName}" id="color_${index + 1}" name="color"`,
                labelForPrefix: 'color',
                labelText: item => item.colorName,
                count: item => item.count,
                afterRender: () => addCheckboxListeners('color', handleCheckboxChange)
            }
        )
    }

    // 옵션 태그
    function searchOption() {
        fetchDataAndRender(
            "/api/search/product/option",
            "optionTag",
            {
                inputAttributes: (item, index) => `value="${item.carGradeNbr}" id="option_${index + 1}" name="option"`,
                labelForPrefix: 'option',
                labelText: item => item.optionName,
                count: item => item.count,
                afterRender: () => addCheckboxListeners('option', handleCheckboxChange)
            }
        );
    }

    function toggleVisibility() {
        let content = document.getElementById('transmissionContent');
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            // 데이터 요청 함수 호출
            searchFuelList();
        } else {
            content.classList.add('hidden');
        }
    }

    // 차량번호 검색
    function searchCarPlatNumber() {
        let searchCarPlateNumber = document.getElementById("searchCarPlateNumber");
        fetchData('/api/search/product', 'POST', {carPlateNumber: searchCarPlateNumber.value}, (result) => {
            if (result.code === 200) {
                renderProductList(result.data);
            } else {
                alert('차량번호로 검색하는 데 실패했습니다.');
            }
        });
    }

    // 오른쪽 상단 (인기순, 최신순, 저가순, 고가순) orderBy
    document.querySelectorAll('input[name="sortBy"]').forEach((tag) => {
        tag.addEventListener("click", () => {
            let sortBy = tag.value;
            fetchData('/api/search/product', 'POST', {sortBy: sortBy}, (result) => {
                renderProductList(result.data);
            });
        });
    })

    // 옵션 더보기 클릭
    function searchMoreOption() {
        fetch("/api/search/product/more/option", {
            method: "POST"
        })
            .then(response => response.json())
            .then(result => {
                if (result.code === 200) {
                    let optionList = result.data;
                    console.log(optionList)
                    renderOptions(optionList);
                }
            });
    }

    function renderOptions(data) {
        let container = document.getElementById("optionListTag");
        let html = '';

        data.forEach(category => {
            html += `
            <div class="option_area">
                <span class="tit">${category.specCtgry}</span>
                <ul class="option_list">
        `;

            category.optionList.forEach(option => {
                const uniqueId = category.specCtgry + '-' + option.id;
                html += `
                <li>
                    <div class="input-wrap">
                        <div class="checkbox">
                            <input type="checkbox" name="convenience" id="${uniqueId}">
                            <label for="${uniqueId}">${option.optNm}</label>
                        </div>
                    </div>
                </li>
            `;
            });

            html += `
                </ul>
            </div>
        `;
        });

        container.innerHTML = html;
    }


    // 검색필터 위에 초기화 버튼 클릭시
    document.getElementById('btn-reset').addEventListener('click', function () {
        // 모든 검색 필터 초기화
        document.getElementById('startYear').value = '';
        document.getElementById('endYear').value = '';
        document.querySelectorAll('input[name="transmission"]:checked').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="option"]:checked').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="sido"]:checked').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="fuel"]:checked').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="color"]:checked').forEach(el => el.checked = false);
        document.querySelectorAll('input[name="sortBy"]:checked').forEach(el => el.checked = false);

        fetchData('/api/search/product', 'POST', {'': ''}, (result) => {
            renderProductList(result.data);
        });
    });

    document.querySelectorAll(".pick_check").forEach(tag => {
        tag.addEventListener("click", function () {
            let productId = tag.getAttribute("productId");
            fetch("/api/sub/pick/v2", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    productId: productId,
                })
            })
                .then(res => res.json())
                .then(result => {
                    if (result.code !== 200) {
                        $popup.alert(result.message, {
                            modal: true,
                            close: () => {
                                location.reload();
                            }
                        })
                    }
                })
        })
    });

    document.addEventListener('DOMContentLoaded', function() {

        let sessionStorageData = sessionStorage.getItem("searchResults");
        let searchResults = JSON.parse(sessionStorageData);
        console.log(searchResults)

        if (searchResults) {
            renderProductList(searchResults);
        }

        const sliderLeft = document.getElementById('slider1-left');
        const sliderRight = document.getElementById('slider1-right');
        const valueLabelLeft = document.querySelector('.value-label.left');
        const valueLabelRight = document.querySelector('.value-label.right');
        const searchDistanceBtn = document.getElementById('searchDistanceBtn');
        const allLabel = document.querySelector('.all');
        const toLabel = document.querySelector('.to');

        function formatNumber(number) {
            return new Intl.NumberFormat().format(number);
        }

        function updateSliderValues() {
            const leftValue = parseInt(sliderLeft.value, 10);
            const rightValue = parseInt(sliderRight.value, 10);
            const maxValue = parseInt(sliderRight.max, 10);

            if (leftValue === 1 && rightValue === maxValue) {
                allLabel.style.display = 'inline';
                valueLabelLeft.style.display = 'none';
                valueLabelRight.style.display = 'none';
                toLabel.style.display = 'none';
            } else {
                allLabel.style.display = 'none';
                valueLabelLeft.style.display = 'inline';
                valueLabelRight.style.display = 'inline';
                toLabel.style.display = 'inline';
                valueLabelLeft.textContent = `${formatNumber(leftValue * 1000)}만원`;
                valueLabelRight.textContent = `${formatNumber(rightValue * 1000)}만원`;
            }
        }

        // 금액 검색 버튼 클릭시
        searchDistanceBtn.addEventListener('click', function() {
            let leftValue, rightValue;
            if (document.getElementById("directPrice").checked) {
                leftValue = parseInt(document.getElementById("leftPrice").value, 10);
                rightValue = parseInt(document.getElementById("rightPrice").value, 10);
            } else {
                leftValue = parseInt(sliderLeft.value, 10) * 1000;
                rightValue = parseInt(sliderRight.value, 10) * 1000;
            }
            fetchData('/api/search/product', 'POST', { startPrice: leftValue, endPrice: rightValue }, (result) => {
                renderProductList(result.data);
            });
        });

        sliderLeft.addEventListener('input', updateSliderValues);
        sliderRight.addEventListener('input', updateSliderValues);

        // 초기 값 설정
        updateSliderValues();

        const sliderLeftKm = document.getElementById('slider2-left');
        const sliderRightKm = document.getElementById('slider2-right');
        const leftValueLabelKm = document.getElementById('left-value');
        const rightValueLabelKm = document.getElementById('right-value');
        const allLabelKm = document.querySelector('.value-area .all');
        const searchUseKmBtnKm = document.getElementById("searchUseKmBtn");

        // 숫자에 천 단위 구분 기호(콤마)를 추가하는 함수
        function formatNumber(number) {
            return new Intl.NumberFormat().format(number);
        }

        function updateLabels() {
            const leftValue = parseInt(sliderLeftKm.value, 10);
            const rightValue = parseInt(sliderRightKm.value, 10);
            const minValue = parseInt(sliderLeftKm.min, 10);
            const maxValue = parseInt(sliderRightKm.max, 10);

            if (leftValue === minValue && rightValue === maxValue) {
                // 전체 범위가 선택된 경우
                allLabelKm.style.display = 'inline';
                leftValueLabelKm.style.display = 'none';
                rightValueLabelKm.style.display = 'none';
            } else {
                // 슬라이더 값이 조정된 경우
                allLabelKm.style.display = 'none';
                leftValueLabelKm.style.display = 'inline';
                rightValueLabelKm.style.display = 'inline';
                leftValueLabelKm.textContent = `${formatNumber(leftValue)}km`;
                rightValueLabelKm.textContent = `${formatNumber(rightValue)}km`;
            }
        }

        function initialize() {
            // 초기 상태를 설정하고 각 슬라이더 값이 범위를 포함하는지 확인
            sliderLeftKm.value = sliderLeftKm.min;
            sliderRightKm.value = sliderRightKm.max;
            updateLabels();
        }

        sliderLeftKm.addEventListener('input', () => {
            if (parseInt(sliderLeftKm.value, 10) > parseInt(sliderRightKm.value, 10)) {
                sliderRightKm.value = sliderLeftKm.value;
            }
            updateLabels();
        });

        sliderRightKm.addEventListener('input', () => {
            if (parseInt(sliderRightKm.value, 10) < parseInt(sliderLeftKm.value, 10)) {
                sliderLeftKm.value = sliderRightKm.value;
            }
            updateLabels();
        });

        initialize();

        searchUseKmBtnKm.addEventListener("click", () => {
            let startKm, endKm;
            let directKm = document.getElementById("directKm");
            if(directKm.checked) {
                startKm = parseInt(document.getElementById("leftKm").value, 10);
                endKm = parseInt(document.getElementById("rightKm").value, 10);
            } else {
                startKm = parseInt(sliderLeftKm.value, 10) * 1000;
                endKm = parseInt(sliderRightKm.value, 10) * 1000;
            }
            fetchData('/api/search/product', 'POST', { startKm: startKm, endKm: endKm }, (result) => {
                renderProductList(result.data);
            });
        })
    });



    // 선택된 필터 값들을 HTML로 업데이트하는 함수
    function updateSelectedFilters() {
        const resultTextElement = document.querySelector('.result-text');
        resultTextElement.innerHTML = '';

        // 선택된 체크박스 값을 가져옵니다.
        const selectedTransmissions = Array.from(document.querySelectorAll('input[name="transmission"]:checked')).map(checkbox => checkbox.nextElementSibling.textContent.trim());
        const selectedOptions = Array.from(document.querySelectorAll('input[name="option"]:checked')).map(checkbox => checkbox.nextElementSibling.textContent.trim());
        const selectedSidos = Array.from(document.querySelectorAll('input[name="sido"]:checked')).map(checkbox => checkbox.nextElementSibling.textContent.trim());
        const selectedFuels = Array.from(document.querySelectorAll('input[name="fuel"]:checked')).map(checkbox => checkbox.nextElementSibling.textContent.trim());
        const selectedColors = Array.from(document.querySelectorAll('input[name="color"]:checked')).map(checkbox => checkbox.nextElementSibling.textContent.trim());

        const selectedCategories = Array.from(document.querySelectorAll('a.category.selected')).map(link => link.textContent.trim());

        // 선택된 항목들을 하나의 배열로 통합합니다.
        const allSelectedFilters = [
            ...selectedTransmissions,
            ...selectedOptions,
            ...selectedSidos,
            ...selectedFuels,
            ...selectedColors,
            ...selectedCategories
        ];

        // 중복된 항목을 제거합니다.
        const uniqueSelectedFilters = [...new Set(allSelectedFilters)];

        // HTML로 업데이트합니다.
        uniqueSelectedFilters.forEach(filter => {
            const filterElement = document.createElement('div');
            filterElement.className = 'txt';
            filterElement.innerHTML = `
            ${filter}
            <button type="button" class="btn-del" onclick="removeFilter('${filter}')">삭제</button>
        `;
            resultTextElement.appendChild(filterElement);
        });
    }

    function addCheckboxListeners(name, callback) {
        document.querySelectorAll(`input[name="${name}"]`).forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                callback();
                updateSelectedFilters(); // 체크박스 변경 시 필터 업데이트
            });
        });
    }

    function addCategoryListeners() {
        document.querySelectorAll('a.category').forEach(link => {
            link.addEventListener('click', event => {
                event.preventDefault();
                link.classList.toggle('selected');
                updateSelectedFilters(); // 카테고리 선택 시 필터 업데이트
            });
        });
    }

    function removeFilter(filterText) {
        // 체크박스 상태를 리셋합니다.
        const checkboxes = ['transmission', 'option', 'sido', 'fuel', 'color'];
        checkboxes.forEach(name => {
            document.querySelectorAll(`input[name="${name}"]`).forEach(checkbox => {
                if (checkbox.nextElementSibling.textContent.trim() === filterText) {
                    checkbox.checked = false;
                }
            });
        });

        // class가 'category'인 a 태그 상태를 리셋합니다.
        document.querySelectorAll('a.category.selected').forEach(link => {
            if (link.textContent.trim() === filterText) {
                link.classList.remove('selected');
            }
        });

        // 필터를 HTML에서 삭제합니다.
        const filterElements = document.querySelectorAll('.result-text .txt');
        filterElements.forEach(element => {
            if (element.textContent.includes(filterText)) {
                element.remove();
            }
        });

        searchProducts(); // 필터가 제거된 후의 검색 결과를 업데이트합니다.
    }

    // 초기화 버튼 클릭
    function resetFilters() {
        // 모든 체크박스 선택 해제
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
        });

        // 모든 카테고리 링크의 선택 상태 제거
        document.querySelectorAll('a.category.selected').forEach(link => {
            link.classList.remove('selected');
        });

        // 결과 텍스트 초기화
        const resultTextElement = document.querySelector('.result-text');
        resultTextElement.innerHTML = '';

        searchProducts();
    }

    // 페이지 로드 시 체크박스 및 카테고리 리스너 등록
    document.addEventListener('DOMContentLoaded', () => {
        addCheckboxListeners('transmission', handleCheckboxChange);
        addCheckboxListeners('option', handleCheckboxChange);
        addCheckboxListeners('sido', handleCheckboxChange);
        addCheckboxListeners('fuel', handleCheckboxChange);
        addCheckboxListeners('color', handleCheckboxChange);
        addCategoryListeners(); // 카테고리 링크 리스너 추가

        // 초기화 버튼 클릭 이벤트 리스너 등록
        const resetButton = document.getElementById('btn-reset-filters');
        if (resetButton) {
            resetButton.addEventListener('click', resetFilters);
        }
    });

    document.addEventListener('click', function(event) {
        if (event.target && event.target.classList.contains('btn-del')) {
            let parentElement = event.target.closest('span.filter.on');
            if (parentElement) {
                parentElement.style.display = 'none';
            }
        }
    });

    // 공통 함수 정의
    function toggleDisplay(directCheckboxId, writeTagId, sliderId) {
        document.getElementById(directCheckboxId).addEventListener("change", () => {
            if(document.getElementById(directCheckboxId).checked) {
                document.getElementById(writeTagId).style.display = 'flex';
                document.getElementById(sliderId).style.display = 'none';
            } else {
                document.getElementById(writeTagId).style.display = 'none';
                document.getElementById(sliderId).style.display = 'block';
            }
        });
    }

    // 이벤트 리스너 등록
    toggleDisplay("directPrice", "writePriceTag", "slider1");
    toggleDisplay("directKm", "writeKm", "slider2");

    function formatNumber(value) {
        return value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function handleInput(event) {
        let value = event.target.value;
        // 숫자가 아닌 문자를 제거
        value = value.replace(/[^\d]/g, '');
        // 콤마 추가
        event.target.value = formatNumber(value);
    }

    document.getElementById("leftPrice").addEventListener("input", handleInput);
    document.getElementById("rightPrice").addEventListener("input", handleInput);
    document.getElementById("leftKm").addEventListener("input", handleInput);
    document.getElementById("rightKm").addEventListener("input", handleInput);

</script>
</html>