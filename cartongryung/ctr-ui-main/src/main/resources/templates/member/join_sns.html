<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="format-detection" content="telephone=no" />
    <meta name="description" content="CUV">
    <link rel="icon" href="/user/images/favicon/favicon_48x48.svg" sizes="48x48">
    <link rel="icon" href="/user/images/favicon/favicon_96x96.svg" sizes="96x96">
    <link rel="icon" href="/user/images/favicon/favicon_144x144.svg" sizes="144x144">
    <link rel="icon" href="/user/images/favicon/favicon_196x196.svg" sizes="196x196">
    <meta property="og:image" content="/user/images/favicon/ogi.png" />
    <meta property="og:image:width" content="270" />
    <meta property="og:image:height" content="270" />
    <meta property="og:title" content="" />
    <meta property="og:description" content="" />
    <title>카통령</title>
    <!-- css -->
    <link rel="stylesheet" href="/user/css/general.css">
    <link rel="stylesheet" href="/user/css/swiper-bundle.min.css">
    <!-- js -->
    <script src="/user/js/jquery-1.12.4.min.js"></script>
    <script src="/user/js/jquery-ui.js"></script>
    <script src="/user/js/layout.js"></script>
    <script src="/user/js/swiper-bundle.min.js"></script>
    <script src="/user/js/wbz-popup.v1.js"></script>
    <script src="/user/js/datepicker-ko.js"></script>
</head>

<body>
<!-- 본문 바로가기 -->
<div id="skipNav"><a href="#contents" onclick="document.getElementById('contents').tabIndex = -1;document.getElementById('contents').focus();return false;">본문 바로가기</a></div>
<div id="container">
    <main id="contents">
        <div class="sub-content">
            <div class="member-wrap">
                <div class="join-wrap">
                    <div class="w-set">
                        <div class="tit-area hide-m">
                            <h2 class="tit">회원가입</h2>
                        </div>
                        <form action="">
                            <div class="input-wrap">
                                <div class="input-item">
                                    <p class="input-tit required">휴대폰 번호</p>
                                    <div class="add-btn">
                                        <input type="text" name="" id="phoneNumber" placeholder="01000000000(입력 시 “-”제외)">
                                        <label for="phoneNumber" class="is-blind">휴대폰 번호</label>
                                        <button type="button" class="btn" id="phoneCheckBtn">인증</button>
                                    </div>
                                    <div class="add-btn">
                                        <input type="text" name="numberCheck" id="numberCheck" placeholder="인증번호">
                                        <label for="numberCheck" class="is-blind">인증번호</label>
                                        <button type="button" class="btn is-disabled" id="checkNumberBtn">확인</button>
                                    </div>
                                    <p class="error-txt" style="display: none">00:00</p>
                                    <!-- <p class="info-txt">인증번호가 일치합니다.</p> -->
                                </div>
                            </div>
                            <div class="terms-wrap">
                                <p class="info-txt">약관에 동의하시고 내 차 맞춤 관리를 시작해보세요.</p>
                                <div class="checkbox all">
                                    <input type="checkbox" id="allCheck">
                                    <label for="allCheck" class="chk">전체 동의</label>
                                </div>
                                <div class="chk-list">
                                    <div class="checkbox">
                                        <input type="checkbox" name="agreeChk" id="agreeChk_1">
                                        <label for="agreeChk_1" class="chk">만 14세 이상입니다. (필수)</label>
                                    </div>
                                    <div class="checkbox">
                                        <input type="checkbox" name="agreeChk" id="agreeChk_2">
                                        <label for="agreeChk_2" class="chk">서비스 이용약관에 동의 (필수)</label>
                                        <button type="button" class="btn-more" onclick="$popup.template('#termsPopup')">더보기</button>
                                    </div>
                                    <div class="checkbox">
                                        <input type="checkbox" name="agreeChk" id="agreeChk_3">
                                        <label for="agreeChk_3" class="chk">개인정보 수집 및 이용에 동의 (필수)</label>
                                        <button type="button" class="btn-more" onclick="$popup.template('#termsPopup')">더보기</button>
                                    </div>
                                    <div class="checkbox">
                                        <input type="checkbox" name="agreeChk" id="agreeChk_4">
                                        <label for="agreeChk_4" class="chk">마케팅 수신 정보 동의 (선택)</label>
                                    </div>
                                </div>
                            </div>
                            <div class="btn-wrap">
                                <button type="button" class="btn is-disabled" id="saveBtn">확인</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
    </div>
</main>

    <!-- 이용약관 팝업 -->
    <div class="wbz-popup-cont is-template" id="termsPopup">
        <div class="popup-header">
            <strong class="popup-title">이용약관</strong>
            <button type="button" class="popup-close" onclick="$popup.close();">✕</button>
        </div>
        <div class="popup-cont">
            <div class="popup-text">
                약관 내용입니다
            </div>
        </div>
    </div>
    <!-- //이용약관 팝업 -->
    <!-- 개인정보 팝업 -->
    <div class="wbz-popup-cont is-template" id="poliPopup">
        <div class="popup-header">
            <strong class="popup-title">개인정보</strong>
            <button type="button" class="popup-close" onclick="$popup.close();">✕</button>
        </div>
        <div class="popup-cont">
            <div class="popup-text">
                약관 내용입니다
            </div>
        </div>
    </div>
    <!-- //개인정보 팝업 -->
    </div>

<script th:inline="javascript">
    //서브 페이지 제목
    var hdNm = "회원가입";


    document.addEventListener("DOMContentLoaded", function() {
        const numberCheckInput = document.getElementById("numberCheck");
        const numberCheckBtn = document.getElementById("checkNumberBtn");

        numberCheckInput.addEventListener("input", function() {
            if (numberCheckInput.value.trim() !== "") {
                numberCheckBtn.removeAttribute("disabled");
            } else {
                numberCheckBtn.setAttribute("disabled", true);
            }
        });

        const phoneNumber = document.getElementById("phoneNumber");
        const numberCheck = document.getElementById("numberCheck");
        const agreeChk1 = document.getElementById("agreeChk_1");
        const agreeChk2 = document.getElementById("agreeChk_2");
        const agreeChk3 = document.getElementById("agreeChk_3");
        const saveBtn = document.getElementById("saveBtn");

        const requiredFields = [phoneNumber, numberCheck, agreeChk1, agreeChk2, agreeChk3];

        function validateForm() {
            const allFilled = requiredFields.every(field => {
                if (field.type === "checkbox") {
                    return field.checked;
                } else {
                    return field.value.trim() !== "";
                }
            });

            if (allFilled) {
                saveBtn.classList.remove("is-disabled");
            } else {
                saveBtn.classList.add("is-disabled");
            }
        }

        requiredFields.forEach(field => {
            field.addEventListener("input", validateForm);
            field.addEventListener("change", validateForm);
        });

        // 전체 동의 체크박스 이벤트 핸들러
        const allCheck = document.getElementById("allCheck");
        allCheck.addEventListener("change", function() {
            const checkboxes = document.querySelectorAll(".chk-list input[type='checkbox']");
            checkboxes.forEach(checkbox => {
                checkbox.checked = allCheck.checked;
            });
            validateForm();
        });

        // 개별 체크박스 체크시 전체 동의 체크박스 상태 업데이트
        const individualCheckboxes = document.querySelectorAll(".chk-list input[type='checkbox']");
        individualCheckboxes.forEach(checkbox => {
            checkbox.addEventListener("change", function() {
                allCheck.checked = Array.from(individualCheckboxes).every(cb => cb.checked);
                validateForm();
            });
        });
    });

    //약관동의 (각각 체크 )
    const providerAll = document.querySelector('input[id="allCheck"]');
    const agreeCheckboxes = document.querySelectorAll('input[name="agreeChk"]');

    providerAll.addEventListener('change', function () {
        agreeCheckboxes.forEach(function (item) {
            item.checked = providerAll.checked;
        });
    });

    // 인증번호 전송 버튼 클릭
    let checkBoolean = false;
    document.getElementById("phoneCheckBtn").onclick = async () => {
        let phoneNumber = document.getElementById("phoneNumber").value;
        let type = "CR002";
        if(phoneNumber.trim() === "") {
            $popup.alert("휴대폰 번호를 입력해주세요.");
            return;
        }

        fetch("/api/join/check/phone", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                phoneNumber: phoneNumber,
                type: type
            })
        })
            .then(res => res.json())
            .then(result => {
                if(result.code === 200) {
                    document.getElementById("phoneCheckBtn").textContent = '재전송';
                    document.getElementById("checkNumberBtn").classList.remove("is-disabled");
                    $popup.alert("인증번호가 발송되었습니다.");
                    document.querySelector('.error-txt').style.display = 'block'; // 타이머 표시
                    startTimer(3 * 60); // 3분 타이머 시작
                }
            });
    }

    function startTimer(duration) {
        let timer = duration, minutes, seconds;
        const display = document.querySelector('.error-txt');
        const interval = setInterval(() => {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(interval);
                display.textContent = "00:00";
                $popup.alert("인증 시간이 만료되었습니다. 다시 시도해주세요.");
                document.getElementById("phoneCheckBtn").textContent = '인증 요청';
                document.getElementById("checkNumberBtn").classList.add("is-disabled");
                display.style.display = 'none'; // 타이머 숨기기
            }
        }, 1000);
    }
    // 전체 동의 체크
    document.querySelectorAll('input[name="agreeChk"]').forEach(function (item) {
        item.addEventListener('change', function () {
            const allChecked = Array.from(document.querySelectorAll('input[name="agreeChk"]')).every(function (checkbox) {
                return checkbox.checked;
            });
            providerAll.checked = allChecked;
        });
    });

    // 확인 버튼 클릭
    document.getElementById("saveBtn").onclick = () => {
        let phoneNumber = document.getElementById("phoneNumber").value;

        fetch("/join/sns/save", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                phoneNumber: phoneNumber,
            }),
        })
            .then(response => response.json())
            .then(result => {
                if(result.code === 200) {
                    $popup.alert(result.message, {
                        modal : true,
                        close : () => {
                            location.href = "/"
                        }
                    })
                } else {
                    $popup.alert(result.message)
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
    }

    // 인증번호 확인 버튼 클릭
    document.getElementById("checkNumberBtn").onclick = () => {
        let numberCheck = document.getElementById("numberCheck").value;
        let phoneNumber = document.getElementById("phoneNumber").value;

        if(numberCheck.trim() === "") {
            $popup.alert("인증번호를 입력해주세요.")
            return false;
        }

        fetch("/api/join/number/check", {
            method : "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                numberCheck: numberCheck,
                phoneNumber :phoneNumber
            })
        })
            .then(res => res.json())
            .then(result => {
                if(result.code === 200) {
                    $popup.alert(result.message)
                    checkBoolean = true;
                    document.getElementById("phoneNumber").disabled = true;
                } else {
                    $popup.alert(result.message)
                }
            })
    }

</script>
</body>
</html>